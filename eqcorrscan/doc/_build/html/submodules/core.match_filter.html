

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4.3. match_filter &mdash; EQcorrscan 0.1.2rc documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/EQcorrscan_logo.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="EQcorrscan 0.1.2rc documentation" href="../index.html"/>
        <link rel="up" title="4. Core" href="../core.html"/>
        <link rel="next" title="5. Utils" href="../utils.html"/>
        <link rel="prev" title="4.2. template_gen" href="core.template_gen.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> EQcorrscan
          

          
            
            <img src="../_static/EQcorrscan_logo.jpg" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">1. Introduction to the EQcorrscan package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../updates.html">2. What&#8217;s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">3. EQcorrscan tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../core.html">4. Core</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="core.bright_lights.html">4.1. bright_lights</a></li>
<li class="toctree-l2"><a class="reference internal" href="core.template_gen.html">4.2. template_gen</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">4.3. match_filter</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../utils.html">5. Utils</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">EQcorrscan</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../core.html">4. Core</a> &raquo;</li>
      
    <li>4.3. match_filter</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/submodules/core.match_filter.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="module-match_filter">
<span id="match-filter"></span><h1>4.3. match_filter<a class="headerlink" href="#module-match_filter" title="Permalink to this headline">¶</a></h1>
<p>Function to cross-correlate templates generated by template_gen function with data and output the detecitons.  The central component of this is the match_template function from the openCV image processing package.  This is a highly optimized and accurate normalized cross-correlation routine.  The details of this code can be found here: <a class="reference external" href="http://www.cs.ubc.ca/research/deaton/remarks_ncc.html">http://www.cs.ubc.ca/research/deaton/remarks_ncc.html</a> </p>
<p>The matched-filter routine described here was used a previous Matlab code for the Chamberlain et al. 2014 G-cubed publication.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">copyright:</th><td class="field-body">Calum Chamberlain, Chet Hopp.</td>
</tr>
<tr class="field-even field"><th class="field-name">license:</th><td class="field-body">GNU Lesser General Public License, Version 3
(<a class="reference external" href="https://www.gnu.org/copyleft/lesser.html">https://www.gnu.org/copyleft/lesser.html</a>)</td>
</tr>
</tbody>
</table>
<dl class="class">
<dt id="match_filter.DETECTION">
<em class="property">class </em><code class="descclassname">match_filter.</code><code class="descname">DETECTION</code><span class="sig-paren">(</span><em>template_name</em>, <em>detect_time</em>, <em>no_chans</em>, <em>detect_val</em>, <em>threshold</em>, <em>typeofdet</em>, <em>chans=None</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/match_filter.html#DETECTION"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#match_filter.DETECTION" title="Permalink to this definition">¶</a></dt>
<dd><p>Information required for a full detection based on cross-channel correlation sums.</p>
<dl class="docutils">
<dt>Attributes:</dt>
<dd><table class="first last docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">type template_name:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><p class="first">str</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">param template_name:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><p class="first">The name of the template for which this detection was made.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">type detect_time:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><table class="first docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">class:</th><td class="field-body">&#8216;obspy.UTCDateTime&#8217;</td>
</tr>
</tbody>
</table>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">param detect_time:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><p class="first">Time of detection as an obspy UTCDateTime object</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">type no_chans:</th><td class="field-body"><p class="first">int</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">param no_chans:</th><td class="field-body"><p class="first">The number of channels for which the cross-channel correlation sum was calculated over.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">type chans:</th><td class="field-body"><p class="first">list of str</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">param chans:</th><td class="field-body"><p class="first">List of stations for the detection</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">type cccsum_val:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><p class="first">float</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">param cccsum_val:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><p class="first">The raw value of the cross-channel correlation sum for this detection.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">type threshold:</th><td class="field-body"><p class="first">float</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">param threshold:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><p class="first">The value of the threshold used for this detection, will be the raw threshold value related to the cccsum.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">type typeofdet:</th><td class="field-body"><p class="first">str</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">param typeofdet:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><p class="first last">Type of detection, STA, corr, bright</p>
</td>
</tr>
</tbody>
</table>
</dd>
</dl>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">Use Obspy.core.event class instead of detection. Requires internal knowledge of template parameters - which needs changes to how templates are stored.</p>
</div>
</dd></dl>

<dl class="function">
<dt id="match_filter._channel_loop">
<code class="descclassname">match_filter.</code><code class="descname">_channel_loop</code><span class="sig-paren">(</span><em>templates</em>, <em>stream</em>, <em>cores=1</em>, <em>debug=0</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/match_filter.html#_channel_loop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#match_filter._channel_loop" title="Permalink to this definition">¶</a></dt>
<dd><p>Loop to generate cross channel correaltion sums for a series of templates hands off the actual correlations to a sister function which can be run in parallel.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>templates</strong> &#8211; A list of templates, where each one should be an obspy.Stream object containing multiple traces of seismic data and the relevant header information.</li>
<li><strong>stream</strong> &#8211; A single obspy.Stream object containing daylong seismic data to be correlated through using the templates.  This is in effect the image.</li>
<li><strong>core</strong> (<em>int</em>) &#8211; Number of cores to loop over</li>
<li><strong>debug</strong> (<em>int</em>) &#8211; Debug level.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">New list of :class: &#8216;numpy.array&#8217; objects.  These will contain the correlation sums for each template for this day of data.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">list of ints as number of channels used for each cross-correlation.</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">list of list of tuples of station, channel for all cross-correlations.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="match_filter._template_loop">
<code class="descclassname">match_filter.</code><code class="descname">_template_loop</code><span class="sig-paren">(</span><em>template</em>, <em>chan</em>, <em>station</em>, <em>channel</em>, <em>debug=0</em>, <em>i=0</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/match_filter.html#_template_loop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#match_filter._template_loop" title="Permalink to this definition">¶</a></dt>
<dd><p>Sister loop to handle the correlation of a single template (of multiple channels) with a single channel of data.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>i</strong> (<em>int</em>) &#8211; Optional argument, used to keep track of which process is being run.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">tuple of (i, ccc) with ccc as an ndarray</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This function currently assumes only one template-channel per data-channel, while this is normal for a standard matched-filter routine, if we wanted to impliment a subspace detector, this would be the function to change, I think.  E.g. where I currently take only the first matching channel, we could loop through all the matching channels and then sum the correlation sums - however I haven&#8217;t yet
implimented detection based on that.  More reading of the Harris document required.</p>
</div>
</dd></dl>

<dl class="function">
<dt id="match_filter.match_filter">
<code class="descclassname">match_filter.</code><code class="descname">match_filter</code><span class="sig-paren">(</span><em>template_names</em>, <em>template_list</em>, <em>st</em>, <em>threshold</em>, <em>threshold_type</em>, <em>trig_int</em>, <em>plotvar</em>, <em>plotdir=u'.'</em>, <em>cores=1</em>, <em>tempdir=False</em>, <em>debug=0</em>, <em>plot_format=u'jpg'</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/match_filter.html#match_filter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#match_filter.match_filter" title="Permalink to this definition">¶</a></dt>
<dd><p>Over-arching code to run the correlations of given templates with a day of seismic data and output the detections based on a given threshold.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>template_names</strong> (<em>list</em>) &#8211; List of template names in the same order as template_list</li>
<li><strong>template_list</strong> (<em>list :class: 'obspy.Stream'</em>) &#8211; A list of templates of which each template is a Stream of obspy traces containing seismic data and header information.</li>
<li><strong>st</strong> &#8211; An obspy.Stream object containing all the data available and required for the correlations with templates given.  For efficiency this should contain no excess traces which are not in one or more of the templates.  This will now remove excess traces internally, but will copy the stream and work on the copy, leaving your input stream untouched.</li>
<li><strong>threshold</strong> (<em>float</em>) &#8211; A threshold value set based on the threshold_type</li>
<li><strong>threshold_type</strong> (<em>str</em>) &#8211; The type of threshold to be used, can be MAD, absolute or av_chan_corr.    MAD threshold is calculated as the threshold*(median(abs(cccsum))) where cccsum is the cross-correlation sum for a given template. absolute threhsold is a true absolute threshold based on the cccsum value av_chan_corr is based on the mean values of single-channel cross-correlations assuming all data are present as required for the template, e.g. av_chan_corr_thresh=threshold*(cccsum/len(template)) where template is a single template from the input and the length is the number of channels within this template.</li>
<li><strong>trig_int</strong> (<em>float</em>) &#8211; Minimum gap between detections in seconds.</li>
<li><strong>plotvar</strong> (<em>bool</em>) &#8211; Turn plotting on or off</li>
<li><strong>plotdir</strong> (<em>str</em>) &#8211; Path to plotting folder, plots will be output here, defaults to run location.</li>
<li><strong>tempdir</strong> (<em>String or False</em>) &#8211; Directory to put temporary files, or False</li>
<li><strong>cores</strong> (<em>int</em>) &#8211; Number of cores to use</li>
<li><strong>debug</strong> (<em>int</em>) &#8211; Debug output level, the bigger the number, the more the output.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last"><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">class:</th><td class="field-body">&#8216;DETECTIONS&#8217; detections for each channel formatted as </td>
</tr>
<tr class="field-even field"><th class="field-name">class:</th><td class="field-body">&#8216;obspy.UTCDateTime&#8217; objects.</td>
</tr>
</tbody>
</table>
</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Plotting within the match-filter routine uses the Agg backend with interactive plotting turned off.  This is because the function is designed to work in bulk.  If you wish to turn interactive plotting on you must import matplotlib in your script first, when you them import match_filter you will get the warning that this call to matplotlib has no effect, which will mean that match_filter has not changed the plotting behaviour.</p>
</div>
</dd></dl>

<dl class="function">
<dt id="match_filter.normxcorr2">
<code class="descclassname">match_filter.</code><code class="descname">normxcorr2</code><span class="sig-paren">(</span><em>template</em>, <em>image</em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/match_filter.html#normxcorr2"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#match_filter.normxcorr2" title="Permalink to this definition">¶</a></dt>
<dd><p>Base function to call the c++ correlation routine from the openCV image processing suite.  Requires you to have installed the openCV python bindings, which can be downloaded on Linux machines using: <strong>sudo apt-get install python-openCV</strong>.</p>
<p>Here we use the cv2.TM_CCOEFF_NORMED method within openCV to give the normalized cross-correaltion.  Documentation on this function can be found here:</p>
<p><strong>http://docs.opencv.org/modules/imgproc/doc/object_detection.html?highlight=matchtemplate#cv2.matchTemplate</strong></p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>template</strong> &#8211; Template array</li>
<li><strong>image</strong> &#8211; image to scan the template through.  The order of these matters, if you put the template after the image you will get a reversed correaltion matrix</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">New :class: &#8216;numpy.array&#8217; object of the correlation values for the correlation of the image with the template.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../utils.html" class="btn btn-neutral float-right" title="5. Utils" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="core.template_gen.html" class="btn btn-neutral" title="4.2. template_gen" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, 2016: Calum John Chamberlain &amp; Chet Hopp.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.2rc',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>